name: 'Cleanup AI Code Review Artifacts'
description: 'Comprehensive cleanup of AI Code Review artifacts with selective options and safety features'

branding:
  icon: 'trash-2'
  color: 'red'

inputs:
  # Cleanup Configuration
  cleanup-type:
    description: 'Type of cleanup to perform (all, embeddings, models, feedback, reports)'
    required: false
    default: 'all'

  older-than-days:
    description: 'Only cleanup artifacts older than specified days (0 = all artifacts)'
    required: false
    default: '30'

  repository:
    description: 'Repository to cleanup artifacts from (format: owner/repo, default: current repo)'
    required: false
    default: ${{ github.repository }}

  # Safety Features
  dry-run:
    description: 'Preview cleanup actions without actually deleting artifacts'
    required: false
    default: 'false'

  require-confirmation:
    description: 'Require explicit confirmation before deletion (interactive mode)'
    required: false
    default: 'false'

  # Selective Cleanup Options
  artifact-name-pattern:
    description: 'Custom artifact name pattern for selective cleanup (supports wildcards)'
    required: false
    default: ''

  exclude-patterns:
    description: 'Comma-separated patterns to exclude from cleanup'
    required: false
    default: ''

  max-artifacts-per-run:
    description: 'Maximum number of artifacts to process in one run (rate limiting)'
    required: false
    default: '50'

  # Output Options
  verbose:
    description: 'Show detailed cleanup progress and artifact information'
    required: false
    default: 'false'

  generate-report:
    description: 'Generate detailed cleanup report as artifact'
    required: false
    default: 'true'

outputs:
  # Cleanup Results
  artifacts-deleted:
    description: 'Number of artifacts successfully deleted'
    value: ${{ steps.cleanup.outputs.artifacts-deleted }}

  space-reclaimed-mb:
    description: 'Estimated storage space reclaimed in MB'
    value: ${{ steps.cleanup.outputs.space-reclaimed }}

  cleanup-summary:
    description: 'Summary of cleanup actions performed'
    value: ${{ steps.cleanup.outputs.summary }}

  # Error Tracking
  errors-count:
    description: 'Number of errors encountered during cleanup'
    value: ${{ steps.cleanup.outputs.errors-count }}

  failed-deletions:
    description: 'List of artifacts that failed to delete'
    value: ${{ steps.cleanup.outputs.failed-deletions }}

  # Performance Metrics
  processing-time:
    description: 'Total time taken for cleanup process (seconds)'
    value: ${{ steps.timing.outputs.duration }}

  artifacts-processed:
    description: 'Total number of artifacts processed (including skipped)'
    value: ${{ steps.cleanup.outputs.artifacts-processed }}

  # Report Information
  cleanup-report-path:
    description: 'Path to the detailed cleanup report'
    value: ${{ steps.cleanup.outputs.report-path }}

runs:
  using: 'composite'
  steps:
    - name: Validate Inputs
      shell: bash
      run: |
        echo "ðŸ” Validating cleanup action inputs..."

        # Validate cleanup type
        VALID_TYPES="all embeddings models feedback reports"
        if [[ ! " $VALID_TYPES " =~ " ${{ inputs.cleanup-type }} " ]]; then
          echo "âŒ Error: Invalid cleanup-type '${{ inputs.cleanup-type }}'. Valid options: $VALID_TYPES"
          exit 1
        fi

        # Validate older-than-days is a non-negative integer
        if ! [[ "${{ inputs.older-than-days }}" =~ ^[0-9]+$ ]]; then
          echo "âŒ Error: older-than-days must be a non-negative integer, got: ${{ inputs.older-than-days }}"
          exit 1
        fi

        # Validate repository format
        if [[ ! "${{ inputs.repository }}" =~ ^[a-zA-Z0-9_.-]+/[a-zA-Z0-9_.-]+$ ]]; then
          echo "âŒ Error: Invalid repository format '${{ inputs.repository }}'. Expected: owner/repo"
          exit 1
        fi

        # Validate max-artifacts-per-run
        if ! [[ "${{ inputs.max-artifacts-per-run }}" =~ ^[0-9]+$ ]] || [ "${{ inputs.max-artifacts-per-run }}" -le 0 ]; then
          echo "âŒ Error: max-artifacts-per-run must be a positive integer, got: ${{ inputs.max-artifacts-per-run }}"
          exit 1
        fi

        echo "âœ… Input validation passed"

    - name: Start Timing
      id: start-timing
      shell: bash
      run: echo "start-time=$(date +%s)" >> $GITHUB_OUTPUT

    - name: Cleanup Artifacts
      id: cleanup
      shell: bash
      working-directory: ${{ github.action_path }}
      env:
        GITHUB_TOKEN: ${{ github.token }}
        GITHUB_OUTPUT: ${{ github.output }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        INPUT_CLEANUP_TYPE: ${{ inputs.cleanup-type }}
        INPUT_OLDER_THAN_DAYS: ${{ inputs.older-than-days }}
        INPUT_REPOSITORY: ${{ inputs.repository }}
        INPUT_DRY_RUN: ${{ inputs.dry-run }}
        INPUT_REQUIRE_CONFIRMATION: ${{ inputs.require-confirmation }}
        INPUT_ARTIFACT_NAME_PATTERN: ${{ inputs.artifact-name-pattern }}
        INPUT_EXCLUDE_PATTERNS: ${{ inputs.exclude-patterns }}
        INPUT_MAX_ARTIFACTS_PER_RUN: ${{ inputs.max-artifacts-per-run }}
        INPUT_VERBOSE: ${{ inputs.verbose }}
        INPUT_GENERATE_REPORT: ${{ inputs.generate-report }}
      run: node cleanup-artifacts.js

    - name: Calculate Processing Time
      id: timing
      shell: bash
      run: |
        START_TIME="${{ steps.start-timing.outputs.start-time }}"
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        echo "duration=${DURATION}" >> $GITHUB_OUTPUT
        echo "â±ï¸ Cleanup completed in ${DURATION} seconds"

    - name: Upload Cleanup Report
      if: inputs.generate-report == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: artifact-cleanup-report-${{ github.run_id }}
        path: ${{ steps.cleanup.outputs.report-path }}
        retention-days: 30
        compression-level: 9
      continue-on-error: true

    - name: Generate Summary
      if: always()
      shell: bash
      run: |
        echo "## ðŸ—‘ï¸ Artifact Cleanup Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| **Repository** | \`${{ inputs.repository }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **Cleanup Type** | \`${{ inputs.cleanup-type }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **Mode** | ${{ inputs.dry-run == 'true' && 'ðŸ” Dry Run' || 'ðŸ—‘ï¸ Live Cleanup' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **Artifacts Processed** | ${{ steps.cleanup.outputs.artifacts-processed }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **Artifacts Deleted** | ${{ steps.cleanup.outputs.artifacts-deleted }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **Space Reclaimed** | ${{ steps.cleanup.outputs.space-reclaimed }} MB |" >> $GITHUB_STEP_SUMMARY
        echo "| **Processing Time** | ${{ steps.timing.outputs.duration }} seconds |" >> $GITHUB_STEP_SUMMARY
        echo "| **Errors** | ${{ steps.cleanup.outputs.errors-count }} |" >> $GITHUB_STEP_SUMMARY


        if [ ${{ steps.cleanup.outputs.errors-count }} -gt 0 ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âŒ Errors Encountered" >> $GITHUB_STEP_SUMMARY
          echo "Failed to delete: \`${{ steps.cleanup.outputs.failed-deletions }}\`" >> $GITHUB_STEP_SUMMARY
          echo "Check the cleanup report for detailed error information." >> $GITHUB_STEP_SUMMARY
        fi

        if [ "${{ inputs.verbose }}" = "true" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Age Filter:** Artifacts older than ${{ inputs.older-than-days }} days" >> $GITHUB_STEP_SUMMARY
          echo "- **Max Artifacts per Run:** ${{ inputs.max-artifacts-per-run }}" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ inputs.artifact-name-pattern }}" ]; then
            echo "- **Custom Pattern:** \`${{ inputs.artifact-name-pattern }}\`" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -n "${{ inputs.exclude-patterns }}" ]; then
            echo "- **Exclude Patterns:** \`${{ inputs.exclude-patterns }}\`" >> $GITHUB_STEP_SUMMARY
          fi
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ Summary" >> $GITHUB_STEP_SUMMARY
        echo "${{ steps.cleanup.outputs.summary }}" >> $GITHUB_STEP_SUMMARY

        if [ "${{ inputs.generate-report }}" = "true" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š **Detailed Report:** \`artifact-cleanup-report-${{ github.run_id }}\`" >> $GITHUB_STEP_SUMMARY
        fi
